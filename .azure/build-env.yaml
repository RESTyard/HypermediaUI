parameters:
  - name: environment
  - name: project
  - name: region
    default: 'eu-central-1'

steps:
  - task: Cache@2
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: $(npm_config_cache)
    displayName: Cache npm $(npm_config_cache)
  - bash: npm ci --cache $(npm_config_cache)
    displayName: 'Clean install project dependencies'
  - bash: npm run build:${{ parameters.environment }}
    displayName: 'Build project'
  - bash: npm run test
    displayName: 'Test project'
  - task: PublishPipelineArtifact@1
    displayName: Publish artifacts
    inputs:
      targetPath: '$(Build.SourcesDirectory)/dist/${{ parameters.environment }}'
      artifact: 'bundles-${{ parameters.environment }}'
      publishLocation: 'pipeline'
